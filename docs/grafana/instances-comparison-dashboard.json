{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "stat",
      "title": "24h Peak Hash Rate (selected instances)",
      "description": "Sum of 24h max per-instance job hash rate across selected instances (trend-friendly)",
      "gridPos": { "h": 5, "w": 8, "x": 0, "y": 0 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\"}[24h:1m]))"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "Global Hash Rate by Instance",
      "description": "sum of per-job hash rate grouped by instance (1m max window for trend)",
      "gridPos": { "h": 8, "w": 16, "x": 8, "y": 0 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "none" }
      }
    },
    {
      "type": "table",
      "title": "Per-Instance Hash Rate (current vs 1h peak)",
      "description": "Current (1m max) and 1h peak per instance (filter by engine)",
      "gridPos": { "h": 9, "w": 8, "x": 0, "y": 5 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "current"
        },
        {
          "refId": "B",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1h:1m]))",
          "legendFormat": "peak_1h"
        }
      ],
      "transformations": [
        {
          "id": "merge",
          "options": {}
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {},
            "aggregations": []
          }
        },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time 1": true,
              "Time 2": true
            },
            "indexByName": {
              "instance": 0,
              "A": 1,
              "B": 2
            },
            "renameByName": {
              "A": "current_ops",
              "B": "peak_1h_ops"
            }
          }
        },
        {
          "id": "calculateField",
          "options": {
            "mode": "binary",
            "binary": {
              "reducer": "last",
              "left": "A",
              "operator": "/",
              "right": "B",
              "replaceFields": false
            },
            "reduce": {
              "reducer": "last"
            },
            "alias": "delta_current_over_peak"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto" },
          "unit": "ops",
          "decimals": 2,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.5 },
              { "color": "red", "value": 0.8 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": { "show": false },
        "frameIndex": 0
      }
    },
    {
      "type": "timeseries",
      "title": "Per-Instance Job Hash Rate (over time)",
      "description": "sum(max_over_time(miner_job_hash_rate[1m])) grouped by instance (filter by engine) for trend",
      "gridPos": { "h": 8, "w": 16, "x": 8, "y": 8 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "none" }
      }
    },
    {
      "type": "timeseries",
      "title": "Average Per-Thread Hash Rate by Instance",
      "description": "avg(max_over_time(miner_thread_hash_rate[1m])) grouped by instance (EMA-smoothed; filter by engine)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "none" }
      }
    },
    {
      "type": "table",
      "title": "Top 15 Jobs by Instance (filter by engine)",
      "gridPos": { "h": 9, "w": 12, "x": 0, "y": 24 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "topk(15, max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "{{instance}}, {{engine}}, {{job_id}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto" },
          "unit": "ops",
          "decimals": 2
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": { "show": false },
        "frameIndex": 0
      }
    },
    {
      "type": "table",
      "title": "Per-Instance Total Hashes (1m increase; filter by engine)",
      "gridPos": { "h": 9, "w": 12, "x": 12, "y": 24 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (increase(miner_job_hashes_total{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto" },
          "unit": "ops",
          "decimals": 0
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": { "show": false },
        "frameIndex": 0
      }
    },
    {
      "type": "timeseries",
      "title": "Per-Instance Per-Engine Job Hash Rate",
      "description": "sum(max_over_time(miner_job_hash_rate[1m])) grouped by instance and engine",
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 33 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance, engine) (max_over_time(miner_job_hash_rate{job=~\"$job\", instance=~\"$instance\", engine=~\"$engine\"}[1m]))",
          "legendFormat": "{{instance}}, {{engine}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "none" }
      }
    },
    {
      "type": "stat",
      "title": "Active Jobs (by instance)",
      "description": "Number of currently running mining jobs on each instance",
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 42 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance) (miner_active_jobs{job=~\"$job\", instance=~\"$instance\"})"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": { "unit": "short" },
        "overrides": []
      }
    },
    {
      "type": "table",
      "title": "Mine Requests (5m increase; by instance & result)",
      "description": "Accepted, duplicate, invalid, error counts",
      "gridPos": { "h": 9, "w": 18, "x": 6, "y": 42 },
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (instance, result) (increase(miner_mine_requests_total{job=~\"$job\", instance=~\"$instance\"}[5m]))",
          "legendFormat": "{{instance}}, {{result}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto" },
          "unit": "short",
          "decimals": 0
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": { "show": false },
        "frameIndex": 0
      }
    }
  ],
  "refresh": "10s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["quantus", "miner", "prometheus", "instances"],
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_PROMETHEUS",
        "hide": 0,
        "query": "prometheus",
        "current": {},
        "options": []
      },
      {
        "type": "query",
        "name": "instance",
        "label": "Instance(s)",
        "hide": 0,
        "datasource": "$DS_PROMETHEUS",
        "definition": "label_values(miner_job_hash_rate, instance)",
        "includeAll": true,
        "multi": true,
        "refresh": 2,
        "sort": 1,
        "query": "label_values(miner_job_hash_rate, instance)",
        "regex": "",
        "current": {
          "selected": false,
          "text": ["All"],
          "value": ["$__all"]
        }
      },
      {
        "type": "query",
        "name": "engine",
        "label": "Engine(s)",
        "hide": 0,
        "datasource": "$DS_PROMETHEUS",
        "definition": "label_values(miner_job_hash_rate, engine)",
        "includeAll": true,
        "multi": true,
        "refresh": 2,
        "sort": 1,
        "query": "label_values(miner_job_hash_rate, engine)",
        "regex": "",
        "current": {
          "selected": false,
          "text": ["All"],
          "value": ["$__all"]
        }
      },
      {
        "type": "query",
        "name": "job",
        "label": "Job(s)",
        "hide": 0,
        "datasource": "$DS_PROMETHEUS",
        "definition": "label_values(miner_job_hash_rate, job)",
        "includeAll": true,
        "multi": true,
        "refresh": 2,
        "sort": 1,
        "query": "label_values(miner_job_hash_rate, job)",
        "regex": "",
        "current": {
          "selected": false,
          "text": ["All"],
          "value": ["$__all"]
        }
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "title": "Quantus Miner - Instances Comparison",
  "version": 1,
  "uid": null
}
